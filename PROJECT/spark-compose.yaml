
services:

  # Apache Spark (Master node)
  # HDFS + Delta lake are contained inside this image
  spark-master:
    image: bitnami/spark:3.5.1
    user: root
    container_name: spark-master
    hostname: spark
    environment:
        SPARK_MODE: master
      # Avoid letting lil spark cook
        SPARK_RPC_AUTHENTICATION_ENABLED: no
        SPARK_RPC_ENCRYPTION_ENABLED: no
        SPARK_LOCAL_STORAGE_ENCRYPTION_ENABLED: no
        SPARK_SSL_ENABLED: no
        SPARK_USER: spark
        SPARK_UI_PORT: 8089
        SPARK_SUBMIT_OPTIONS: '--packages.io.delta:core-core_2.12:2.4.0'
    ports:
        - "7077:7077" # MASTER PORTS
        - "8089:8080" # SPARK DASHBOARD UI
    volumes:
      # Spark Script folder (same path as airflow)
      - ./spark/app:/usr/local/spark/app
      # Spark Resources folder (same path as airflow)
      - ./spark/resource:/usr/local/spark/resources 
      # Tests paths
      - ./spark/tests:/usr/local/spark/tests

  spark-worker-1:
    image: bitnami/spark:3.5.1
    user: root 
    hostname: spark-worker-1
    container_name: spark-worker-1
    environment:
        SPARK_MODE: worker
        SPARK_MASTER_URL: spark://spark:7077
        SPARK_WORKER_MEMORY: 1G
        SPARK_WORKER_CORES: 1
        SPARK_RPC_AUTHENTICATION_ENABLED: no
        SPARK_RPC_ENCRYPTION_ENABLED: no
        SPARK_LOCAL_STORAGE_ENCRYPTION_ENABLED: no
        SPARK_SSL_ENABLED: no
        SPARK_USER: spark
        
  spark-worker-2:
    image: bitnami/spark:3.5.1
    user: root 
    hostname: spark-worker-2
    container_name: spark-worker-2
    environment:
        SPARK_MODE: worker
        SPARK_MASTER_URL: spark://spark:7077
        SPARK_WORKER_MEMORY: 1G
        SPARK_WORKER_CORES: 1
        SPARK_RPC_AUTHENTICATION_ENABLED: no
        SPARK_RPC_ENCRYPTION_ENABLED: no
        SPARK_LOCAL_STORAGE_ENCRYPTION_ENABLED: no
        SPARK_SSL_ENABLED: no
        SPARK_USER: spark

